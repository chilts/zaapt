%# ----------------------------------------------------------------------------
<%doc>
    Note: $my_perms is not a required arg, so make sure the person editing this
    is allowed to.
</%doc>
%# ----------------------------------------------------------------------------
<%args>
    $zaapt
    $id
    $_act        => ''
    $a_firstname => ''
    $a_lastname  => ''
    $a_email     => ''
    $a_notify    => 1
    $a_password  => ''
    $a_repeat    => ''
</%args>
%# ----------------------------------------------------------------------------
<%init>
    my $model = $zaapt->get_model('Account');
    my $account = $model->sel_account({ a_id => $id });

    my $err_info = [];
    my $err_pass = [];

    if ( $_act eq 'update' ) {
        # turn notify into a boolean
        $a_notify = ( $a_notify eq 1 ? 1 : 0 );

        my $empty = 0;
        foreach ( $a_firstname, $a_lastname, $a_email ) {
            Zaapt::Utils::Valid::has_content( $_ )
                or $empty++;
        }
        push @$err_info, "At least one field is blank, please enter all fields" if $empty;

        unless ( @$err_info ) {
            my $model = $zaapt->get_model('Account');
            $model->upd_account({
                a_firstname => $a_firstname,
                a_lastname  => $a_lastname,
                a_email     => $a_email,
                a_notify    => $a_notify,
                a_id        => $id,
            });
            $m->comp('/zaapt/common/refresh-session.mhtml', zaapt => $zaapt, id => $id);
            $m->clear_buffer();
            $m->redirect('.');
            return;
        }
    }
    elsif ( $_act eq 'password' ) {
        # check the passwords are okay

        my $empty = 0;
        foreach ( $a_password, $a_repeat ) {
            $empty++ unless m{ \S }xms;
        }
        push @$err_pass, "At least one field is blank, please enter all fields" if $empty;

        unless ( $a_password eq $a_repeat ) {
            push @$err_pass, "Password and the repeat are not the same, please re-type";
        }

        unless ( length $a_password >= 6 ) {
            push @$err_pass, "Password must be at least 6 characters long.";
        }

        unless ( @$err_pass ) {
            my $model = $zaapt->get_model('Account');
            $model->upd_password({
                a_password => $a_password,
                a_id       => $id,
            });
            $m->clear_buffer();
            $m->redirect('.');
            return;
        }
    }
</%init>
%# ----------------------------------------------------------------------------
<& render-user-upd.mhtml,
    err_info => $err_info,
    a_firstname => $a_firstname,
    a_lastname => $a_lastname,
    a_email => $a_email,
    a_notify => $a_notify,
    err_pass => $err_pass,
&>
%# ----------------------------------------------------------------------------
